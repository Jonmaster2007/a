-- unbreakable noclip module
local RS = game:GetService("RunService")
local LP = game.Players.LocalPlayer

local Clip = true
local Conns = {}

local function forceNoCollide()
    if Clip then return end
    local char = LP.Character
    if not char then return end

    for _, part in ipairs(char:GetDescendants()) do
        if part:IsA("BasePart") then
            -- why: repeated enforcing prevents external scripts from breaking noclip
            part.CanCollide = false
        end
    end
end

local function connectLoops()
    -- kill old connections
    for _, c in ipairs(Conns) do
        c:Disconnect()
    end
    Conns = {}

    table.insert(Conns, RS.RenderStepped:Connect(forceNoCollide))
    table.insert(Conns, RS.Stepped:Connect(forceNoCollide))
    table.insert(Conns, RS.Heartbeat:Connect(forceNoCollide))
end

local function disconnectLoops()
    for _, c in ipairs(Conns) do
        c:Disconnect()
    end
    Conns = {}

    local char = LP.Character
    if char then
        for _, part in ipairs(char:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = true
            end
        end
    end
end


local function noclip()
    Clip = false
    connectLoops()
end

local function clip()
    Clip = true
    disconnectLoops()
end

local function toggle()
    if Clip then
        noclip()
    else
        clip()
    end
end

_G.NoclipModule = {
    noclip = noclip,
    clip = clip,
    toggle = toggle,
}
