local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
local floatName = "HumanoidRootPart"

local Clip = true
local Noclipping = nil
local wasNoclipBeforeDeath = false

_G.NoclipModule = {}

-------------------------------------------------------------
-- INTERNAL noclip loop
-------------------------------------------------------------
local function NoclipLoop()
    local char = LocalPlayer.Character
    if Clip or not char then return end

    for _, child in ipairs(char:GetDescendants()) do
        if child:IsA("BasePart")
        and child.CanCollide == true
        and child.Name ~= floatName then
            child.CanCollide = false
        end
    end
end

-------------------------------------------------------------
-- Enable noclip
-------------------------------------------------------------
function _G.NoclipModule.noclip()
    Clip = false
    wasNoclipBeforeDeath = true

    task.wait(0.05)

    if Noclipping then
        Noclipping:Disconnect()
    end

    Noclipping = RunService.Stepped:Connect(NoclipLoop)
end

-------------------------------------------------------------
-- Disable noclip
-------------------------------------------------------------
function _G.NoclipModule.clip()
    Clip = true

    -- âœ” do NOT clear wasNoclipBeforeDeath here
    -- (otherwise respawn breaks)

    if Noclipping then
        Noclipping:Disconnect()
        Noclipping = nil
    end
end

-------------------------------------------------------------
-- Toggle noclip
-------------------------------------------------------------
function _G.NoclipModule.toggle()
    if Clip then
        _G.NoclipModule.noclip()
    else
        _G.NoclipModule.clip()
    end
end

-------------------------------------------------------------
-- RESPAWN SUPPORT (stable)
-------------------------------------------------------------
LocalPlayer.CharacterAdded:Connect(function(char)
    task.wait(1) -- ensure ALL parts exist

    -- safe check
    if wasNoclipBeforeDeath then
        _G.NoclipModule.noclip()
    end
end)

-------------------------------------------------------------
-- Detect final respawn (when player is fully loaded)
-------------------------------------------------------------
LocalPlayer.CharacterRemoving:Connect(function()
    -- don't touch wasNoclipBeforeDeath
    -- it must remain TRUE so respawn logic works
end)
