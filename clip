local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
local floatName = "HumanoidRootPart"

-- STATE
local Clip = true
local Noclipping = nil
local keepEnabled = false -- controlled by your UI toggle

_G.NoclipModule = {}

-------------------------------------------------------------
-- INTERNAL noclip loop
-------------------------------------------------------------
local function NoclipLoop()
    if Clip then return end

    local char = LocalPlayer.Character
    if not char then return end

    for _, child in ipairs(char:GetDescendants()) do
        if (child:IsA("BasePart") or child:IsA("MeshPart"))
        and child.CanCollide
        and child.Name ~= floatName then
            child.CanCollide = false
        end
    end
end

-------------------------------------------------------------
-- FULL CLEAN SHUTDOWN
-------------------------------------------------------------
local function disconnectLoop()
    if Noclipping then
        Noclipping:Disconnect()
        Noclipping = nil
    end
end

-------------------------------------------------------------
-- Enable noclip
-------------------------------------------------------------
function _G.NoclipModule.noclip()
    keepEnabled = true
    Clip = false

    disconnectLoop()
    Noclipping = RunService.Heartbeat:Connect(NoclipLoop)
end

-------------------------------------------------------------
-- Disable noclip
-------------------------------------------------------------
function _G.NoclipModule.clip()
    keepEnabled = false
    Clip = true
    disconnectLoop()
end

-------------------------------------------------------------
-- Toggle noclip
-------------------------------------------------------------
function _G.NoclipModule.toggle()
    if Clip then
        _G.NoclipModule.noclip()
    else
        _G.NoclipModule.clip()
    end
end

-------------------------------------------------------------
-- Character Removing (death)
-- Always force noclip OFF
-------------------------------------------------------------
LocalPlayer.CharacterRemoving:Connect(function()
    Clip = true
    disconnectLoop()
end)

-------------------------------------------------------------
-- Character Added (respawn)
-- Restore noclip only if your UI toggle says so
-------------------------------------------------------------
LocalPlayer.CharacterAdded:Connect(function()
    task.wait(0.5) -- ensure parts exist

    if keepEnabled then
        _G.NoclipModule.noclip()
    else
        _G.NoclipModule.clip()
    end
end)
